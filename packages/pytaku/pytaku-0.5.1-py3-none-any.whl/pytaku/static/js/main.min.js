(()=>{function F(t){let e={};return t.split(";").forEach(r=>{let[s,n]=r.split("=");e[s]=n}),e}var o={username:sessionStorage.getItem("username"),userId:sessionStorage.getItem("userId"),token:F(document.cookie).token||null,isLoggedIn:()=>o.username!==null&&o.userId!==null,init:()=>o.isLoggedIn()?(console.log("Already logged in"),Promise.resolve()):o.token===null?(console.log("No saved token found"),Promise.resolve()):m.request({method:"GET",url:"/api/verify-token"}).then(t=>{sessionStorage.setItem("username",t.username),sessionStorage.setItem("userId",t.user_id),o.username=t.username,o.userId=t.user_id}).catch(t=>{t.code==401&&o.clearCredentials()}).finally(m.redraw),saveLoginResults:({userId:t,username:e,token:r,remember:s})=>{sessionStorage.setItem("userId",t),sessionStorage.setItem("username",e),o.userId=t,o.username=e,o.token=r},logout:()=>o.request({method:"POST",url:"/api/logout"}).then(o.clearCredentials).catch(t=>{t.code==401?o.clearCredentials():console.log(t)}),clearCredentials:()=>{o.username=null,o.token=null,o.userId=null,sessionStorage.clear()},request:t=>m.request(t).catch(e=>{throw e.code==401?o.clearCredentials():e.code==500&&alert(e.response.message),e})},g={query:"",result:{},cache:{},isLoading:!0,performSearch:t=>{g.query=t,g.cache[t]?g.result=g.cache[t]:(g.isLoading=!0,m.redraw(),m.request({method:"GET",url:"/api/search/:query",params:{query:t}}).then(e=>{g.cache[t]=e.results,g.result=e.results}).catch(e=>{console.log("TODO",e)}).finally(()=>{g.isLoading=!1}))}},q={cache:{},cacheGet:(t,e,r)=>{let s=[t,e,r].join(",");return q.cache[s]||null},cacheSet:(t,e,r,s)=>{let n=[t,e,r].join(",");q.cache[n]=s},get:({site:t,titleId:e,chapterId:r})=>{let s=q.cacheGet(t,e,r);return s?Promise.resolve(s):o.request({method:"GET",url:"/api/chapter/:site/:titleId/:chapterId",params:{site:t,titleId:e,chapterId:r}}).then(n=>(q.cacheSet(t,e,r,n),n))}};var S={view:t=>m("h2.blink",[m("i.icon.icon-loader.spin")," loading..."])},y={view:t=>m("button",Object.assign({class:t.attrs.color||""},t.attrs),[t.attrs.icon?m(`i.icon.icon-${t.attrs.icon}`):null,t.attrs.text?m("span",t.attrs.text):null])},T={view:t=>m("div.utils--chapter",[m(m.route.Link,{href:`/m/${t.attrs.site}/${t.attrs.titleId}/${t.attrs.chapter.id}`,class:"touch-friendly"},[t.attrs.chapter.is_read?m("i.icon.icon-check-square.utils--chapter--read-icon"):null,m("span",P(t.attrs.chapter)),t.attrs.chapter.groups.map(e=>m("span.utils--chapter--group",j(e,20)))])])};function j(t,e){return t.length>e?`${t.substring(0,e)}...`:t}function P(t){let e="";return typeof t.num_major!="undefined"&&(e+=(t.volume?"Ch.":"Chapter ")+t.num_major),t.num_minor&&(e+="."+t.num_minor),t.volume&&(e+=" Vol. "+t.volume),t.name&&(e+=" - "+t.name),e}function V(t){let e=!1;return{view:r=>{let s;return o.isLoggedIn()?s=m("span.nav--greeting",[m("span",["Welcome, ",m("b",o.username)]),m(y,{text:e?" logging out":" logout",icon:"log-out",color:"red",title:"Log out",onclick:n=>{e=!0,m.redraw(),o.logout().then(()=>{m.route.set("/")}).finally(()=>{e=!1})},disabled:e?"disabled":null})]):s=m(m.route.Link,{class:"nav--link",href:"/a"},[m("i.icon.icon-log-in"),"login / register"]),m("nav",[m(m.route.Link,{class:"nav--logo",href:o.isLoggedIn()?"/f":"/"},[m("img.nav--logo--favicon",{src:"/static/favicon.svg",alt:"home"}),m("img.nav--logo--img",{src:"/static/pytaku.svg",alt:"home"})]),m("form.nav--search-form",{onsubmit:n=>{n.preventDefault(),m.route.set("/s/:query",{query:g.query})}},[m("input[placeholder=search manga title]",{onchange:n=>{g.query=n.target.value},value:g.query}),m(y,{color:"red",icon:"search",type:"submit"})]),s])}}}var K={view:t=>[m(V),t.children]},C=K;function Y(t){let e,r,s=!1,n,c,a,d,h,w,I=!1,f=!1;return{oncreate:b=>{document.title="Authentication - Pytaku"},view:b=>m("div.content.auth",[m("form.auth--form",{onsubmit:l=>{l.preventDefault(),n="",f=!0,m.redraw(),m.request({method:"POST",url:"/api/login",body:{username:e,password:r,remember:s}}).then(u=>{let L=u.user_id,_=u.token,i=e;o.saveLoginResults({userId:L,username:i,token:_,remember:s}),m.route.set("/f")}).catch(u=>{n=u.response.message}).finally(()=>{f=!1})}},[m("h1","Login"),m("input[placeholder=username][name=username][required]",{value:e,oninput:l=>{e=l.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:r,oninput:l=>{r=l.target.value}}),m("label[for=auth--remember].auth--checkbox-label",[m("input[type=checkbox][name=remember][id=auth--remember]",{checked:s,onchange:l=>{s=l.target.checked}})," Remember me"]),m(y,{type:"submit",disabled:f?"disabled":null,text:f?" Logging in...":" Log in",icon:"log-in",color:"blue"}),m("p.auth--form--error-message",n)]),m("form.auth--form",{onsubmit:l=>{if(l.preventDefault(),h="",m.redraw(),a!==d){h="Password confirmation didn't match!",w=!1;return}I=!0,m.redraw(),m.request({method:"POST",url:"/api/register",body:{username:c,password:a}}).then(u=>{w=!0,h=u.message,e=c,r=a}).catch(u=>{h=u.response.message,w=!1}).finally(()=>{I=!1})}},[m("h1","Register"),m("input[placeholder=username][name=username][required]",{value:c,oninput:l=>{c=l.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:a,oninput:l=>{a=l.target.value}}),m("input[placeholder=confirm password][name=confirm][type=password][required]",{value:d,oninput:l=>{d=l.target.value}}),m(y,{type:"submit",disabled:I?"disabled":null,text:I?" Registering...":" Register",icon:"user-plus",color:"green"}),m("p",{class:"auth--form--message-"+(w?"success":"error")},h)])])}}var $=Y;var W={oncreate:t=>{document.title="Pytaku"},view:t=>m("div.content",[m("p","Try searching for some manga title using the box above."),m("p","Logging in allows you to follow manga titles.")])},M=W;var z={view:t=>{let e=t.attrs.title,r=3;return m("div.follows--title"+(e.chapters.length===0?".empty":".non-empty"),[m("div",[m(m.route.Link,{href:`/m/${e.site}/${e.id}`,title:`${e.name} - ${e.site}`},[m("img.follows--cover",{src:e.thumbnail,alt:e.name})])]),m("div.follows--chapters",[e.chapters.length>r?m(m.route.Link,{href:`/m/${e.site}/${e.id}`,class:"follows--chapter follows--more"},`and ${e.chapters.length-r} more...`):"",e.chapters.slice(-r).map(s=>m(T,{site:e.site,titleId:e.id,chapter:s}))])])}};function H(t){let e=[],r=!1;return{oninit:()=>{r=!0,o.request({method:"GET",url:"/api/follows"}).then(s=>{e=s.titles}).catch(s=>{console.log(s)}).finally(()=>{r=!1})},oncreate:s=>{document.title="Stuff I follow - Pytaku"},view:s=>{let n="";return r?m("div.content",m(S)):e.length===0?m("div.content",[m("p","You're not following any title yet. Try searching for some."),m("p",["Migrating from Tachiyomi? ",m(m.route.Link,{href:"/i"},"Use the importer"),"!"])]):m("div.follows.content",[e.map(c=>m(z,{title:c}))])}}}var D=H;var Q={oninit:t=>{document.title=`"${t.attrs.query}" search results`,g.performSearch(t.attrs.query)},view:t=>m("div.content",g.isLoading?m(S):g.result.map(({site:e,titles:r})=>m("div",[m("h1.search--site-heading",e),r?m("p.search--result-text",["Showing ",m("strong",r.length),` result${r.length>1?"s":""} for `,g.query]):m("p.search--result-text",`No results for "${g.query}"`),m("div.search--results",r.map(s=>m(m.route.Link,{class:"search--result",href:`/m/${e}/${s.id}`,title:s.name},[m("img",{src:s.thumbnail,alt:s.name}),m("span",j(s.name,50))])))])))},O=Q;function Z(t){let e=!1,r=!1,s=!1,n=!1,c=null,a={},d,h,w;return{oninit:I=>{document.title="Manga",e=!0,m.redraw(),o.request({method:"GET",url:"/api/title/:site/:titleId",params:{site:I.attrs.site,titleId:I.attrs.titleId}}).then(f=>{a=f,document.title=a.name}).finally(()=>{e=!1})},view:I=>{if(!e&&o.isLoggedIn()){d=!0,h=!0,w=a.chapters.length;for(var f=a.chapters.length-1;f>=0;f--)a.chapters[f].is_read?(w===f+1&&(w=f),h=!1):d=!1}return m("div.content",e?m(S):[m("h1",a.name),m("div.title--details",[o.isLoggedIn()?[m(y,{icon:"bookmark",disabled:r?"disabled":null,text:r?"submitting...":a.is_following?"following":"follow",color:a.is_following?"red":"green",title:a.is_following?"Click to unfollow":"Click to follow",onclick:b=>{r=!0,m.redraw(),o.request({method:"POST",url:"/api/follow",body:{site:a.site,title_id:a.id,follow:!a.is_following}}).then(l=>{a.is_following=l.follow}).finally(()=>{r=!1})}}),m(y,{icon:"check-square",disabled:s||d?"disabled":null,text:s?"submitting...":d?"all read!":"read all",color:"green",title:d?null:"Click to mark all chapters as read",onclick:b=>{!window.confirm("Are you sure you want to read all chapters?")||(s=!0,m.redraw(),o.request({method:"POST",url:"/api/read",body:{read:a.chapters.filter(u=>!u.is_read).map(u=>({site:a.site,title_id:a.id,chapter_id:u.id}))}}).then(u=>{a.chapters.forEach(L=>{L.is_read=!0})}).finally(()=>{s=!1}))}}),m(y,{icon:"x-square",disabled:n||h?"disabled":null,text:n?"submitting...":h?"all unread!":"unread all",color:"white",title:h?null:"Click to mark all chapters as unread",onclick:b=>{!window.confirm("Are you sure you want to unread all chapters?")||(n=!0,m.redraw(),o.request({method:"POST",url:"/api/read",body:{unread:a.chapters.filter(u=>u.is_read).map(u=>({site:a.site,title_id:a.id,chapter_id:u.id}))}}).then(u=>{a.chapters.forEach(L=>{L.is_read=!1})}).finally(()=>{n=!1}))}})]:null,m("a.touch-friendly[title=Go to source site][target=_blank]",{href:a.source_url},[a.site,m("i.icon.icon-arrow-up-right")])]),m("img.title--cover[alt=cover]",{src:a.cover}),m(".title--descriptions",{},[a.descriptions.map(b=>m("p",a.descriptions_format==="html"?m.trust(b):b))]),a.chapters?a.chapters.map((b,l)=>m(".title--chapter-row",[l<w?m(y,{icon:c!==null&&l>=c?"loader":"chevrons-down",color:"green",title:"Mark all read up to this chapter",disabled:c!==null&&l>=c?"disabled":null,onclick:u=>{if(!window.confirm("Are you sure you want to mark all chapters up to this point as read?"))return;c=l,m.redraw();let _=a.chapters.slice(l).filter(i=>!i.is_read);if(_.length==0){c=null,m.redraw();return}o.request({method:"POST",url:"/api/read",body:{read:_.map(i=>({site:a.site,title_id:a.id,chapter_id:i.id}))}}).then(i=>{_.forEach(p=>{p.is_read=!0})}).finally(()=>{c=null})}}):null,m(T,{site:a.site,titleId:a.id,chapter:b})])):m("p","This one has no chapters.")])}}}var N=Z;var J=43,X=45,ee=48,te=63,re={view:()=>m("h2",[m("i.icon.icon-loader.spin")])},se={view:()=>m("h2",[m("i.icon.icon-loader")])},oe={view:t=>m(y,{text:"Errored. Try again?",color:"red",onclick:e=>{let{page:r}=t.attrs;r.status=A.LOADING,r.src=r.src.endsWith("?")?r.src.slice(0,-1):r.src+"?"}})},A={LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"};function R(t){let e;return{oninit:r=>{e=r.attrs.src},view:r=>m("img",{src:e,style:r.attrs.style,onload:r.attrs.onload,onerror:s=>{e===r.attrs.src&&r.attrs.altsrc!==null?e=r.attrs.altsrc:r.attrs.onerror(s)}})}}function ae(t){let e=!1,r=!1,s={},n=[],c=[],a,d,h=null,w=null,I=[],f=100;function b(i){switch(i.keyCode){case J:f+=20;break;case X:f>20&&(f-=20);break;case ee:f=100;break;case te:window.alert(`Keyboard shortcuts:
    + to increase page size
    - to decrease page size
    0 (zero) to reset page size`);break}m.redraw()}function l(){if(c.length>0){let[i,p]=c.splice(0,1)[0];n.push({status:A.LOADING,src:i,altsrc:p})}else s.next_chapter&&h===null&&(h=q.get({site:a,titleId:d,chapterId:s.next_chapter.id}).then(i=>{console.log("Preloading next chapter:",P(i)),i.pages_alt.length>0?w=i.pages.map((p,v)=>[p,i.pages_alt[v]]):w=i.pages.map(p=>[p,null]),u(),u()}))}function u(){if(w!==null&&w.length>0){let[i,p]=w.splice(0,1)[0];I.push({src:i,altsrc:p})}}function L(i,p,v){return o.request({method:"POST",url:"/api/read",body:{read:[{site:i,title_id:p,chapter_id:v}]}})}function _(i,p,v){let E=v?`/m/${i}/${d}/${v.id}`:`/m/${i}/${d}`;return m("div.chapter--buttons",[p?m(m.route.Link,{class:"touch-friendly",href:`/m/${i}/${d}/${p.id}`},[m("i.icon.icon-chevrons-left"),m("span","prev")]):m(y,{text:"prev",icon:"chevrons-left",disabled:!0}),m(m.route.Link,{class:"touch-friendly",href:`/m/${i}/${d}`},[m("i.icon.icon-list"),m("span"," chapter list")]),m(m.route.Link,{class:"touch-friendly"+(r?" disabled":""),href:E,disabled:r,onclick:x=>{o.isLoggedIn()&&(v?L(i,d,s.id):(x.preventDefault(),r=!0,m.redraw(),L(i,d,s.id).finally(()=>{r=!1,m.route.set(E)})))}},[m("span",v?"next":r?"finishing...":"finish"),r?null:m("i.icon.icon-"+(v?"chevrons-right":"check-circle"))])])}return{oncreate:i=>{document.addEventListener("keypress",b)},onremove:i=>{document.removeEventListener("keypress",b)},oninit:i=>{document.title="Manga chapter",a=i.attrs.site,d=i.attrs.titleId,e=!0,m.redraw(),q.get({site:i.attrs.site,titleId:i.attrs.titleId,chapterId:i.attrs.chapterId}).then(p=>{s=p,document.title=P(s),s.pages_alt.length>0?c=s.pages.map((v,E)=>[v,s.pages_alt[E]]):c=s.pages.map(v=>[v,null]),l(),l(),l()}).finally(()=>{e=!1})},view:i=>{if(e)return m("div.chapter.content",m(S));let{site:p,titleId:v}=i.attrs,E=s.prev_chapter,x=s.next_chapter;return m("div.chapter.content",[m("h1",P(s)),_(p,E,x),m("div",{class:"chapter--pages"+(s.is_webtoon?" chapter--webtoon":"")},[n.map((k,le)=>m("div",{key:k.src},[m(R,{src:k.src,altsrc:k.altsrc,style:{display:k.status===A.SUCCEEDED?"block":"none",maxWidth:`${f}%`},onload:B=>{k.status=A.SUCCEEDED,l()},onerror:B=>{k.status=A.FAILED,l()}}),k.status===A.LOADING?m(re):null,k.status===A.FAILED?m("div",{style:{"margin-bottom":".5rem"}},m(oe,{page:k})):null])),c.map(()=>m(se))]),_(p,E,x),I.map(k=>m(R,{style:{display:"none"},onload:u,onerror:u,src:k.src,altsrc:k.altsrc}))])}}}var G=ae;function ie(t){let e=null,r=null,s=!1;return{oninit:n=>{document.title="Import from Tachiyomi"},view:n=>m("div.content",[m("h1","Importing from Tachiyomi"),m("form[enctype=multipart/form-data]",{onsubmit:c=>{c.preventDefault();let a=document.getElementById("tachiyomi").files[0],d=new FormData;d.append("tachiyomi",a),s=!0,e=null,m.redraw(),o.request({method:"POST",url:"/api/import",body:d}).then(h=>{e=h.message,r=!0}).catch(h=>{e=h.response.message,r=!1}).finally(()=>{s=!1})}},[m("p",["Go to ",m("b","Settings > Backup > Create backup"),", then upload the generated json file here:"]),m("input[type=file][id=tachiyomi].importer--filepicker"),m("br"),m(y,{type:"submit",text:s?"uploading...":"upload",color:"green",icon:"upload",disabled:s?"disabled":null})]),m("p",{class:`importer--${r?"success":"failure"}`},e),r?m(m.route.Link,{href:"/f"},"See your following list here."):null])}}var U=ie;o.init().then(()=>{let t=document.getElementById("spa-root");m.route.prefix="",m.route(t,"/",{"/":{onmatch:()=>{if(o.isLoggedIn())m.route.set("/f",null,{replace:!0});else return M},render:e=>m(C,e)},"/a":{onmatch:()=>{if(o.isLoggedIn())m.route.set("/f",null,{replace:!0});else return $},render:e=>m(C,e)},"/f":{onmatch:()=>{if(o.isLoggedIn())return D;m.route.set("/a",null,{replace:!0})},render:e=>m(C,e)},"/s/:query":{render:e=>m(C,m(O,{query:e.attrs.query,key:e.attrs.query}))},"/m/:site/:titleId":{render:e=>m(C,m(N,{site:e.attrs.site,titleId:e.attrs.titleId}))},"/m/:site/:titleId/:chapterId":{render:e=>m(C,m(G,{site:e.attrs.site,titleId:e.attrs.titleId,chapterId:e.attrs.chapterId,key:e.attrs.chapterId}))},"/i":{onmatch:()=>{if(o.isLoggedIn())return U;m.route.set("/a",null,{replace:!0})},render:e=>m(C,e)}})});})();
//# sourceMappingURL=main.min.js.map
