(self.webpackChunk_jupyterlab_pullrequests=self.webpackChunk_jupyterlab_pullrequests||[]).push([[317],{5753:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>X});var n=s(6753),i=s(1396),l=s(71),a=s(6143),d=s(7363),r=s(5185),o=s(6271),c=s.n(o),u=s(3277),h=s(6247);async function p(e,t,s){const n={method:t,body:JSON.stringify(s)},l=h.ServerConnection.makeSettings(),a=i.URLExt.join(l.baseUrl,e),d=await h.ServerConnection.makeRequest(a,n,l);if(!d.ok)throw new h.ServerConnection.ResponseError(d);return d.json()}function m(e,t,s,n){const i=document.createElement(e);if(t)for(const e in t)i.setAttribute(e,t[e]);if(s&&(i.textContent=s),n)for(const e in n)i.addEventListener(e,n[e]);return i}var g=s(6186),f=s(968);var C;function w(e){const{disabled:t,title:s,onClick:n,icon:i}=e;return o.createElement("button",{disabled:t,className:"jp-PullRequestButton",title:s,onClick:n},o.createElement(i.react,{elementPosition:"center",tag:"span"}))}!function(e){e.prOpenDescription="pullrequests:open-description",e.prOpenDiff="pullrequests:open-diff"}(C||(C={}));var R=s(3529);function _(e){return o.createElement("div",{className:"jp-PullRequestBrowserFileItem",title:e.file.name},o.createElement(R.y,{filepath:e.file.name,filetype:e.file.fileType}),o.createElement("span",{className:"jp-PullRequestBrowserFileItemChanged"},e.file.status))}function v(e){const{commands:t,docRegistry:s,pullRequest:n}=e,[i,l]=c().useState(null),[a,d]=c().useState(!1),[r,o]=c().useState(!1),[h,m]=c().useState(null);c().useEffect((()=>{l(null),d(!1),o(!1),m(null)}),[e.pullRequest]);return c().createElement("li",{key:n.id,onClick:()=>{t.execute(C.prOpenDescription,{pullRequest:n})}},c().createElement("div",{className:"jp-PullRequestBrowserItemListItem"},c().createElement("h2",null,n.title),c().createElement("div",{className:"jp-PullRequestBrowserItemListItemIconWrapper"},c().createElement(w,{icon:f.linkIcon,onClick:e=>{var t;e.stopPropagation(),t=n.link,window.open(t,"_blank")},title:"Open in new tab"}),c().createElement(w,{icon:a?f.caretUpIcon:f.caretDownIcon,onClick:e=>{e.stopPropagation(),null!==i||a?d(!a):(m(null),(async()=>{o(!0);try{const e=await p("pullrequests/prs/files?id="+encodeURIComponent(n.id),"GET");l(e.map((e=>{const t=e.name;return Object.assign(Object.assign({},e),{fileType:s.getFileTypesForPath(t)[0]||g.DocumentRegistry.getDefaultTextFileType()})})))}finally{o(!1)}})().then((()=>{d(!a)})).catch((e=>{m(`Failed to get pull request files ${e}`)})))},title:a?"Hide modified files":"Show modified files"}))),r?c().createElement(u.BeatLoader,{sizeUnit:"px",size:5,color:"var(--jp-ui-font-color1)",loading:r}):a&&(h?c().createElement("div",null,c().createElement("h2",{className:"jp-PullRequestBrowserGroupError"},"Error Listing Pull Request Files:"),h):c().createElement("ul",{className:"jp-PullRequestBrowserItemFileList"},null==i?void 0:i.map((e=>c().createElement("li",{key:`${n.internalId}-${e.name}`,onClick:s=>{s.stopPropagation(),t.execute(C.prOpenDiff,{file:e,pullRequest:n})}},c().createElement(_,{file:e})))))))}function q(e){return o.createElement("li",{className:"jp-PullRequestBrowserGroup"},o.createElement("header",null,o.createElement("h2",null,e.group.name)),e.group.error?o.createElement("h2",{className:"jp-PullRequestBrowserGroupError"},o.createElement("span",{style:{color:"var(--jp-ui-font-color1)"}},"Error Listing Pull Requests:")," ",e.group.error):o.createElement("ul",{className:"jp-PullRequestBrowserGroupList"},e.group.pullRequests.map((t=>o.createElement(v,{key:t.id,commands:e.commands,docRegistry:e.docRegistry,pullRequest:t})))))}function P(e){return o.createElement("div",{className:"jp-PullRequestBrowser"},o.createElement("ul",null,e.prGroups.map((t=>o.createElement(q,{key:t.name,commands:e.commands,docRegistry:e.docRegistry,group:t})))))}function E(e){return c().createElement("div",{className:"lm-Widget jp-Toolbar jp-scrollbar-tiny jp-PullRequestToolbar"},c().createElement("div",{className:"jp-PullRequestToolbarHeader"},c().createElement("h2",null,"Pull Requests")),c().createElement("div",{className:"jp-PullRequestToolbarItem"},c().createElement(w,{icon:f.refreshIcon,title:"Refresh",onClick:e.onRefresh})))}class j extends r.ReactWidget{constructor(e,t){super(),this._commands=e,this._docRegistry=t}onBeforeShow(e){super.onBeforeShow(e),this.update()}onBeforeHide(e){super.onBeforeHide(e),this.onBeforeDetach(e)}render(){return this.isAttached&&this.isVisible&&c().createElement(b,{commands:this._commands,docRegistry:this._docRegistry})}}function b(e){const[t,s]=(0,o.useState)([]),[n,i]=(0,o.useState)(!0),l=()=>{i(!0),async function(e){return Promise.all([{name:"Created by Me",filter:"created"},{name:"Assigned to Me",filter:"assigned"}].map((async e=>{var t;try{const t=await p("pullrequests/prs/user?filter="+e.filter,"GET");return{name:e.name,pullRequests:t}}catch(s){let n="Unknown Error";return(null===(t=s.response)||void 0===t?void 0:t.status)&&s.message&&(n=`${s.response.status} (${s.message})`),{name:e.name,pullRequests:[],error:n}}})))}().then((e=>{s(e),i(!1)})).catch((e=>{console.error("Failed to fetch pull requests",e),s([]),i(!1)}))};return(0,o.useEffect)(l,[]),c().createElement("div",{className:"jp-PullRequestPanel"},c().createElement(E,{onRefresh:l}),n?c().createElement(u.BeatLoader,{sizeUnit:"px",size:5,color:"var(--jp-ui-font-color1)",loading:n}):c().createElement(P,{docRegistry:e.docRegistry,commands:e.commands,prGroups:t}))}var y=s(3706),I=s(1797),W=s(6393),k=s.n(W);s(8386);class D extends y.Widget{constructor(e){super(),this._comment="",this.addClass("jp-PullRequestInputContainer"),this.initNode(),this._handleSubmit=e.handleSubmit,this._handleRemove=e.handleCancel}get comment(){return this._comment}set comment(e){this._comment!==e&&(this._comment=e,this.node.getElementsByClassName("jp-PullRequest-CommentButton")[0].disabled=""===this._comment)}handleCancel(e){this._handleRemove()}handleInputChange(e){this.comment=e.getValue()}handleSubmit(e){this._comment&&this._handleSubmit(this._comment)}initNode(){const e=m("div",{class:"jp-PullRequestInputButtonContainer"});e.appendChild(m("button",{class:"jp-Button-flat jp-mod-styled jp-mod-reject"},"Cancel",{click:this.handleCancel.bind(this)})),e.appendChild(m("button",{class:"jp-Button-flat jp-PullRequest-CommentButton jp-mod-styled jp-mod-accept",disabled:!0},"Comment",{click:this.handleSubmit.bind(this)}));const t=this.node.appendChild(m("div",{class:"jp-PullRequestCommentItemContent"})),s=t.appendChild(m("textarea",{class:"jp-PullRequestInputForm jp-PullRequestInputFormTextArea",placeholder:"Leave a comment",value:""}));k().fromTextArea(s,{mode:"markdown",theme:"jupyter",lineWrapping:!0}).on("change",this.handleInputChange.bind(this)),t.appendChild(e)}}var x=s(4031),N=s.n(x);class S extends y.Widget{constructor(e){const{comment:t,renderMime:s}=e,n=s.createRenderer("text/markdown");super({node:S.createNode(t,n)}),this._markdownRenderer=n,this._markdownRenderer.renderModel({data:{"text/markdown":t.text},trusted:!1,metadata:{},setData:()=>null})}static createNode(e,t){const s=m("div",{class:"jp-PullRequestCommentItem"});s.appendChild(m("div",{class:"jp-PullRequestCommentItemImg"})).appendChild(m("img",{src:e.userPicture,altText:"Avatar"}));const n=s.appendChild(m("div",{class:"jp-PullRequestCommentItemContent"})),i=n.appendChild(m("p",{class:"jp-PullRequestCommentItemContentTitle"}));return i.appendChild(m("strong",null,e.userName)),i.appendChild(m("span",{class:"jp-PullRequestGrayedText",title:new Date(e.updatedAt).toString()},N()(e.updatedAt).fromNow())),n.appendChild(t.node),s}dispose(){this.isDisposed||(this._markdownRenderer.dispose(),super.dispose())}}class T extends y.Panel{constructor(e){super(),this._isExpanded=!0,this.addClass("jp-PullRequestThread"),this._handleRemove=e.handleRemove,this._inputShown=0===e.thread.comments.length,this._thread=e.thread,this._renderMime=e.renderMime,this.initNode()}get isExpanded(){return this._isExpanded}set isExpanded(e){if(this._isExpanded!==e){for(this._isExpanded=e;this.widgets.length>1;){const e=this.widgets[this.widgets.length-1];e.parent=null,e.dispose()}if(this._isExpanded)this.addThreadView();else{const e=this._thread.comments[0]?`<strong>${this._thread.comments[0].userName}</strong> ${this._thread.comments[0].text}`:"Leave a comment",t=m("div",{class:"jp-PullRequestCommentItem"});t.appendChild(m("div",{class:"jp-PullRequestCommentItemContent"})).appendChild(m("p",{class:"jp-PullRequestCommentItemContentTitle"})).innerHTML=e,this.addWidget(new y.Widget({node:t}))}}}get inputShown(){return this._inputShown}set inputShown(e){if(this._inputShown!==e){this._inputShown=e;const t=this.widgets[this.widgets.length-1];t.parent=null,t.dispose(),this._inputShown?this.addWidget(this.createCommentInput()):!0!==this._thread.singleton&&this.addWidget(this.createReplyButton())}}initNode(){const e=m("button",{class:"jp-PullRequestExpandButton"});e.appendChild(f.caretUpIcon.element({tag:"span",title:"Collapse Discussion"})),this.addWidget(new y.Widget({node:e})),this.addThreadView(),e.addEventListener("click",(()=>{e.replaceChild(this.isExpanded?f.caretDownIcon.element({tag:"span"}):f.caretUpIcon.element({tag:"span"}),e.firstChild),e.title=this.isExpanded?"Expand Discussion":"Collapse Discussion",this.isExpanded=!this.isExpanded}))}addThreadView(){this._thread.comments.forEach((e=>{this.addWidget(new S({comment:e,renderMime:this._renderMime}))})),this._inputShown?this.addWidget(this.createCommentInput()):!0!==this._thread.singleton&&this.addWidget(this.createReplyButton())}async handleAddComment(e){let t={text:e};t=0===this._thread.comments.length?Object.assign(Object.assign({},t),{line:this._thread.line,originalLine:this._thread.originalLine}):Object.assign(Object.assign({},t),{discussionId:this._thread.id});let s=`pullrequests/files/comments?id=${encodeURIComponent(this._thread.pullRequestId)}`;this._thread.filename&&(s+=`&filename=${encodeURIComponent(this._thread.filename)}`);try{const e=await p(s,"POST",t),n={id:e.id,text:e.text,updatedAt:e.updateAt,userName:e.userName,userPicture:e.userPicture};e.inReplyTo&&(this._thread.id=e.inReplyTo),this._thread.comments.push(n);const i=this.widgets[this.widgets.length-1];i.parent=null,i.dispose(),this.addWidget(new S({comment:n,renderMime:this._renderMime})),this._inputShown=!1,this.addWidget(this.createReplyButton())}catch(e){console.error(e),(0,r.showErrorMessage)("Error","Failed to add the comment.")}}handleCancelComment(){0===this._thread.comments.length?this._handleRemove():this.inputShown=!1}createCommentInput(){const e=new D({handleSubmit:this.handleAddComment.bind(this),handleCancel:this.handleCancelComment.bind(this)});return e.addClass("jp-PullRequestCommentItem"),e}createReplyButton(){const e=m("div",{class:"jp-PullRequestCommentItem"});return e.appendChild(m("div",{class:"jp-PullRequestCommentItemContent"})).appendChild(m("button",{class:"jp-PullRequestReplyButton jp-PullRequestGrayedText"},"Reply...",{click:()=>{this.inputShown=!0}})),new y.Widget({node:e})}}class L extends r.MainAreaWidget{constructor(e){const t=new y.Panel,s=new I.PromiseDelegate;super({content:t,reveal:s.promise}),this.pullRequestId=e.pullRequest.id,this.renderMime=e.renderMime,t.addClass("jp-PullRequestTab");const n=new y.Panel;n.addClass("jp-PullRequestDescriptionTab"),n.addWidget(L.createHeader(e.pullRequest.title,e.pullRequest.link));const i=e.renderMime.createRenderer("text/markdown");n.addWidget(i),Promise.all([i.renderModel({data:{"text/markdown":e.pullRequest.body},trusted:!1,metadata:{},setData:()=>null}),this.loadComments(n,e.pullRequest.id,e.renderMime)]).then((()=>{s.resolve(),this.content.addWidget(n)})).catch((e=>{s.reject(e)}))}async loadComments(e,t,s){return await p(`pullrequests/files/comments?id=${encodeURIComponent(t)}`,"GET").then((t=>(this.threads=t,t.forEach((t=>{const n=new T({renderMime:s,thread:t,handleRemove:()=>null});e.addWidget(n)})),e.addWidget(this.createNewThreadButton(e)),Promise.resolve()))).catch((t=>(e.addWidget(this.createNewThreadButton(e)),Promise.reject(t))))}static createHeader(e,t){const s=m("div",{class:"jp-PullRequestDescriptionHeader"});return s.appendChild(m("h1",{},e)),s.appendChild(m("button",{class:"jp-Button-flat jp-mod-styled jp-mod-accept"},"View Details",{click:()=>{window.open(t,"_blank")}})),new y.Widget({node:s})}createNewThreadButton(e){const t=m("div",{class:"jp-PullRequestThread"});return t.appendChild(m("div",{class:"jp-PullRequestCommentItem"})).appendChild(m("div",{class:"jp-PullRequestCommentItemContent"})).appendChild(m("button",{class:"jp-PullRequestReplyButton jp-PullRequestGrayedText"},"Start a new discussion",{click:()=>{var t;if(0!==(null===(t=this.threads[this.threads.length-1])||void 0===t?void 0:t.comments.length)){const t={comments:new Array,pullRequestId:this.pullRequestId};this.threads.push(t);const s=new T({thread:t,renderMime:this.renderMime,handleRemove:()=>{const e=this.threads.findIndex((e=>t.id===e.id));this.threads.splice(e,1),s.parent=null,s.dispose()}});e.insertWidget(e.widgets.length-1,s)}}})),new y.Widget({node:t})}}var M,A=s(267),B=s(5658),O=s(1380),U=s.n(O),V=s(3127),$=s(7842),G=s(5494);class F extends $.NotebookDiffWidget{constructor(e){super(e.model,e.renderMime),this._chunkIndex=0,this._filename=e.filename,this._pullRequestId=e.pullRequestId,this.__renderMime=e.renderMime,this._threads=e.comments}addDiscussion(e,t,s,n){var i;const l=this._threads[e].threads;if(0!==(null===(i=l[l.length-1])||void 0===i?void 0:i.comments.length)){const e={comments:new Array,pullRequestId:this._pullRequestId,filename:this._filename};e[n]=s+1,l.push(e),t.addWidget(this.makeThreadWidget(e,l))}}addWidget(e){var t,s;if(e.hasClass(G.CHUNK_PANEL_CLASS)){const t=e;if(0===t.widgets[0].widgets.length&&t.widgets[1].widgets.length>1)return[...t.widgets[1].widgets].forEach((e=>{const s=new y.Panel;s.addClass(G.CHUNK_PANEL_CLASS);const n=new y.Panel;n.addClass(G.ADDED_CHUNK_PANEL_CLASS);const i=new y.Panel;i.addClass(G.REMOVED_CHUNK_PANEL_CLASS),i.addWidget(e),s.addWidget(n),s.addWidget(i),this.addWidget(s),t.widgets[1].layout.removeWidget(e)})),void t.dispose();if(0===t.widgets[1].widgets.length&&t.widgets[0].widgets.length>1)return[...t.widgets[0].widgets].forEach((e=>{const s=new y.Panel;s.addClass(G.CHUNK_PANEL_CLASS);const n=new y.Panel;n.addClass(G.ADDED_CHUNK_PANEL_CLASS);const i=new y.Panel;i.addClass(G.REMOVED_CHUNK_PANEL_CLASS),n.addWidget(e),s.addWidget(n),s.addWidget(i),this.addWidget(s),t.widgets[0].layout.removeWidget(e)})),void t.dispose()}if(e instanceof $.CellDiffWidget||e.hasClass(G.CHUNK_PANEL_CLASS)||e instanceof $.MetadataDiffWidget){let n=this._chunkIndex;e instanceof $.MetadataDiffWidget?n=this._threads.length-1:this._chunkIndex+=1;const i=m("div",{class:"jp-PullRequestCellDiffCommentContainer"}),l=new y.Panel;l.addClass("jp-PullRequestCellDiffContent"),l.addWidget(e),l.addWidget(new y.Widget({node:i}));const a=new y.Panel;a.addClass("jp-PullRequestCellDiff"),e.node.classList.contains(`${G.UNCHANGED_DIFF_CLASS}`)&&(a.addClass("jp-git-unchanged"),a.node.addEventListener("click",(e=>{a.hasClass("jp-git-unchanged")&&(a.removeClass("jp-git-unchanged"),a.node.title="")})),a.node.title="Click to display unchanged cell."),a.addWidget(l);const d=this._threads[n].threads;d.forEach(((e,t,s)=>{a.addWidget(this.makeThreadWidget(e,s))})),d.length>0&&a.node.setAttribute("data-pullrequest-hasthread",d.length.toString());const r=null===(t=this._threads[n].range)||void 0===t?void 0:t.end,o=null===(s=this._threads[n].originalRange)||void 0===s?void 0:s.end;i.appendChild(m("div",{class:"jp-PullRequestCellDiffComment"},null,{click:()=>this.addDiscussion(n,a,r||o||0,r?"line":"originalLine")})).appendChild(m("div",{class:"jp-PullRequestCommentDecoration"})),e=a}super.addWidget(e)}makeThreadWidget(e,t){const s=new T({renderMime:this.__renderMime,thread:e,handleRemove:()=>{const n=t.findIndex((t=>e.id===t.id));t.splice(n,1),s.parent=null,s.dispose()}});return s}}class H extends A.NotebookDiff{constructor(e){super(new B.j({challenger:{content:()=>Promise.resolve(e.diff.head.content),label:e.diff.head.label,source:e.diff.head.sha},filename:e.filename,reference:{content:()=>Promise.resolve(e.diff.base.content),label:e.diff.base.label,source:e.diff.base.sha}}),e.renderMime),this._props=e}static mapThreadsOnChunks(e,t,s,n){const i=new Array(s.length+1);for(let e=0;e<i.length;e++)i[e]={threads:new Array};const l=[...n].sort(((e,t)=>null!==e.line&&null!==t.line?e.line-t.line:null!==e.originalLine&&null!==t.originalLine?e.originalLine-t.originalLine:0));let a,d=-1,r=-1,o=-1;do{o+=1,a=l[o]}while(o<l.length&&a.line<t.cells[0].start&&a.originalLine<e.cells[0].start);o>0&&(i[i.length-1].threads=l.splice(0,o));for(let n=0;n<s.length;n++){const a=s[n];for(const s of a){let a=!0,o=!0,c=0;for(null!==s.source.base&&(d+=1,i[n].originalRange=e.cells[d]),null!==s.source.remote&&(r+=1,i[n].range=t.cells[r]);(a||o)&&c<l.length;){const e=l[c];if(null!==s.source.base){const t=i[n].originalRange;if((null==t?void 0:t.start)<=e.originalLine-1&&e.originalLine-1<=(null==t?void 0:t.end)){i[n].threads.push(...l.splice(c,1));continue}a=!1}if(null!==s.source.remote){const t=i[n].range;if((null==t?void 0:t.start)<=e.line-1&&e.line-1<=(null==t?void 0:t.end)){i[n].threads.push(...l.splice(c,1));continue}o=!1}c++}}}return o<l.length&&i[i.length-1].threads.push(...l.slice(o,l.length)),i[i.length-1].range=t.metadata,i[i.length-1].originalRange=e.metadata,i}async createDiffView(e,t){const s=await p("git/diffnotebook","POST",{currentContent:e,previousContent:t}),n=new V.NotebookDiffModel(s.base,s.diff),i=M.computeNotebookMapping(t||"{}"),l=M.computeNotebookMapping(e||"{}"),a=H.mapThreadsOnChunks(i,l,H.reChunkCells(n.chunkedCells),this._props.threads);return new F({pullRequestId:this._props.pullRequestId,filename:this._props.filename,model:n,comments:a,renderMime:this._props.renderMime})}static reChunkCells(e){const t=[];for(const s of e)if(1!==s.length||s[0].added||s[0].deleted){let e=[null,null];for(const n of s)n.deleted?null===e[0]?e[0]=n:(t.push(e.filter((e=>null!==e))),e=[n,null]):null===e[1]?e[1]=n:(t.push(e.filter((e=>null!==e))),e=[null,n]);null===e[0]&&null===e[1]||t.push(e.filter((e=>null!==e)))}else t.push([s[0]]);return t}}!function(e){e.computeNotebookMapping=function(e){var t,s;const n=U().parse(e);return{metadata:{start:null===(t=n.pointers["/metadata"])||void 0===t?void 0:t.key.line,end:null===(s=n.pointers["/metadata"])||void 0===s?void 0:s.valueEnd.line},cells:(n.data.cells||[]).map(((e,t)=>({start:n.pointers[`/cells/${t}`].value.line,end:n.pointers[`/cells/${t}`].valueEnd.line})))}}}(M||(M={}));class z extends A.PlainTextDiff{constructor(e){super(new B.j({challenger:{content:()=>Promise.resolve(e.diff.head.content),label:e.diff.head.label,source:e.diff.head.sha},filename:e.filename,reference:{content:()=>Promise.resolve(e.diff.base.content),label:e.diff.base.label,source:e.diff.base.sha}})),this._threadWidgets=[],this._props=e}dispose(){var e;if(!this.isDisposed){for(;this._threadWidgets.length>0;){const t=this._threadWidgets.pop();t.discussion.node.remove(),t.discussion.dispose(),null===(e=t.wrapper)||void 0===e||e.clear()}super.dispose()}}static makeCommentDecoration(){return m("div",{class:"jp-PullRequestCommentDecoration"})}setCommentGutter(e,t,s,n){e.clearGutter("jp-PullRequestCommentDecoration");for(let i=t;i<s;i++){const t=z.makeCommentDecoration();t.addEventListener("click",(()=>{this.createThread(e,i,n)})),e.setGutterMarker(i,"jp-PullRequestCommentDecoration",t)}}async createDiffView(e,t){if(await super.createDiffView(e,t),this._mergeView){{const{from:e,to:t}=this._mergeView.leftOriginal().getViewport();this.updateView(this._mergeView.leftOriginal(),e,t,"originalLine"),this._mergeView.leftOriginal().on("viewportChange",((e,t,s)=>{this.updateView(e,t,s,"originalLine")}))}{const{from:e,to:t}=this._mergeView.editor().getViewport();this.updateView(this._mergeView.editor(),e,t,"line"),this._mergeView.editor().on("viewportChange",((e,t,s)=>{this.updateView(e,t,s,"line")}))}}}createThread(e,t,s){if(!this._props.threads.find((e=>e[s]===t+1&&0===e.comments.length))){const n={comments:new Array,pullRequestId:this._props.pullRequestId,filename:this._props.filename};n[s]=t+1,this._props.threads.push(n);const i={line:t,side:s,discussion:this.makeThreadWidget(n)};this._threadWidgets.push(i),i.wrapper=e.addLineWidget(t,i.discussion.node)}}getDefaultOptions(){return Object.assign(Object.assign({},super.getDefaultOptions()),{gutters:["CodeMirror-linenumbers","jp-PullRequestCommentDecoration","CodeMirror-patchgutter"]})}makeThreadWidget(e){const t=new T({renderMime:this._props.renderMime,thread:e,handleRemove:()=>{const s=this._props.threads.findIndex((t=>e.id===t.id));this._props.threads.splice(s,1),this.removeThreadWidget(t)}});return t}updateView(e,t,s,n){this.setCommentGutter(e,t,s,n),this._threadWidgets.filter((e=>e.side===n&&(e.line<t||e.line>s))).forEach((e=>this.removeThreadWidget(e.discussion))),this._props.threads.filter((e=>null!==e[n]&&t<e[n]&&e[n]<=s)).forEach((t=>{const s=t[n]-1;if(t.id&&!this._threadWidgets.some((e=>e.id===t.id))){const i={line:s,id:t.id,side:n,discussion:this.makeThreadWidget(t)};this._threadWidgets.push(i),i.wrapper=e.addLineWidget(s,i.discussion.node)}}))}removeThreadWidget(e){var t;const s=this._threadWidgets.splice(this._threadWidgets.findIndex((t=>t.discussion===e)),1)[0];s.discussion.node.remove(),s.discussion.dispose(),null===(t=s.wrapper)||void 0===t||t.clear()}}class K extends r.MainAreaWidget{constructor(e){const t=new y.Panel,s=new I.PromiseDelegate;super({content:t,reveal:s.promise}),t.addClass("jp-PullRequestTab"),K.loadDiff(e.pullRequestId,e.filename).then((([t,n])=>{s.resolve(),this.showDiff(Object.assign(Object.assign({},e),{diff:t,threads:n}))})).catch((t=>{let n=`Load File Error (${t.message})`;t.message.toLowerCase().includes("'utf-8' codec can't decode")&&(n=`Diff for ${e.filename} is not supported.`),s.reject(n)}))}static async loadDiff(e,t){return Promise.all([p(`pullrequests/files/content?id=${encodeURIComponent(e)}&filename=${encodeURIComponent(t)}`,"GET"),p(`pullrequests/files/comments?id=${encodeURIComponent(e)}&filename=${encodeURIComponent(t)}`,"GET")])}showDiff(e){if(".ipynb"===i.PathExt.extname(e.filename).toLowerCase())this.content.addWidget(new H(e));else try{this.content.addWidget(new z(e))}catch(e){this.showError(e.message||e)}}showError(e){for(;this.children().next();)this.children().next().dispose();this.node.innerHTML=`<h2 class="jp-PullRequestTabError"><span style="color: 'var(--jp-ui-font-color1)';">Error Loading File:</span> ${e}</h2>`}}const J=new f.LabIcon({name:"pullrequests:icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="16" viewBox="0 0 1024 1024">\n    <g style="">\n        <rect fill="none" id="canvas_background" height="1026" width="1026" y="-1" x="-1" />\n        <path\n            d="m832,754s0,-306 0,-402s-96,-192 -192,-192c-64,0 -64,0 -64,0l0,-128l-192,192l192,192l0,-128s32,0 64,0s64,32 64,64s0,402 0,402c-38,22 -64,63 -64,110c0,71 57,128 128,128s128,-57 128,-128c0,-47 -26,-88 -64,-110zm-64,174c-35,0 -64,-29 -64,-64s29,-64 64,-64s64,29 64,64s-29,64 -64,64zm-512,-832c-71,0 -128,57 -128,128c0,47 26,88 64,110l0,419c-38,22 -64,63 -64,110c0,71 57,128 128,128s128,-57 128,-128c0,-47 -26,-88 -64,-110l0,-419c38,-22 64,-63 64,-110c0,-71 -57,-128 -128,-128zm0,832c-35,0 -64,-29 -64,-64s29,-64 64,-64s64,29 64,64s-29,64 -64,64zm0,-640c-35,0 -64,-29 -64,-64s29,-64 64,-64s64,29 64,64s-29,64 -64,64z"\n            class="jp-icon3" fill="#616161" />\n    </g>\n</svg>'});function Q(e,t){const s=e.widgets("main");let n=s.next();for(;n&&n.id!==t;)n=s.next();return n}const X={id:"@jupyterlab/pullrequests",requires:[n.ILayoutRestorer,a.IRenderMimeRegistry],optional:[d.ISettingRegistry],activate:function(e,t,s,n){const{commands:a,shell:d}=e;a.addCommand(C.prOpenDescription,{label:"Open Pull Request Description",caption:"Open Pull Request Description in a New Tab",execute:e=>{const t=e.pullRequest;if(!t)return;let n=Q(d,t.id);n||(n=new L({pullRequest:t,renderMime:s}),n.id=t.id,n.title.label=t.title,n.title.caption=t.title,n.title.icon=J,n.title.closable=!0,d.add(n,"main")),d.activateById(n.id)}}),a.addCommand(C.prOpenDiff,{label:"Open Pull Request File Diff",caption:"Open Pull Request File Diff in a New Tab",execute:e=>{const{pullRequest:t,file:a}=e;if(!t||!a)return;const r=`${t.internalId}-${a.name}`;let o=Q(d,r);o||(o=new K({filename:a.name,pullRequestId:t.id,renderMime:s,settingsRegistry:n}),o.id=r,o.title.label=i.PathExt.basename(a.name),o.title.caption=a.name,o.title.icon=l.D4,o.title.closable=!0,d.add(o,"main")),d.activateById(o.id)}});const r=new j(a,e.docRegistry);r.id="pullRequests",r.title.icon=J,r.title.caption="Pull Requests",t.add(r,"pullrequests"),d.add(r,"right",{rank:1e3})},autoStart:!0}}}]);