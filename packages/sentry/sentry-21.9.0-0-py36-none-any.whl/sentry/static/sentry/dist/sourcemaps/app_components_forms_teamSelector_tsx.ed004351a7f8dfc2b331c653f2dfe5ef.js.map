{"version":3,"file":"chunks/app_components_forms_teamSelector_tsx.xxxxxxxxxxxxxxxxxxxx.js","mappings":"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","sources":["webpack:///./app/components/forms/teamSelector.tsx"],"sourcesContent":["import {useEffect, useRef, useState} from 'react';\nimport {StylesConfig} from 'react-select';\nimport styled from '@emotion/styled';\n\nimport {addTeamToProject} from 'app/actionCreators/projects';\nimport Button from 'app/components/button';\nimport SelectControl, {ControlProps} from 'app/components/forms/selectControl';\nimport IdBadge from 'app/components/idBadge';\nimport Tooltip from 'app/components/tooltip';\nimport {IconAdd, IconUser} from 'app/icons';\nimport {t} from 'app/locale';\nimport space from 'app/styles/space';\nimport {Organization, Project, Team} from 'app/types';\nimport useApi from 'app/utils/useApi';\nimport withOrganization from 'app/utils/withOrganization';\nimport withTeams from 'app/utils/withTeams';\n\nconst UnassignedWrapper = styled('div')`\n  display: flex;\n  align-items: center;\n`;\n\nconst StyledIconUser = styled(IconUser)`\n  margin-left: ${space(0.25)};\n  margin-right: ${space(1)};\n  color: ${p => p.theme.gray400};\n`;\n\n// An option to be unassigned on the team dropdown\nconst unassignedOption = {\n  value: null,\n  label: (\n    <UnassignedWrapper>\n      <StyledIconUser size=\"20px\" />\n      {t('Unassigned')}\n    </UnassignedWrapper>\n  ),\n  searchKey: 'unassigned',\n  actor: null,\n  disabled: false,\n};\n\n// Ensures that the svg icon is white when selected\nconst unassignedSelectStyles: StylesConfig = {\n  option: (provided, state) => ({\n    ...provided,\n    svg: {\n      color: state.isSelected && state.theme.white,\n    },\n  }),\n};\n\nconst placeholderSelectStyles: StylesConfig = {\n  input: (provided, state) => ({\n    ...provided,\n    display: 'grid',\n    gridTemplateColumns: 'max-content 1fr',\n    alignItems: 'center',\n    gridGap: space(1),\n    ':before': {\n      backgroundColor: state.theme.backgroundSecondary,\n      height: 24,\n      width: 24,\n      borderRadius: 3,\n      content: '\"\"',\n      display: 'block',\n    },\n  }),\n  placeholder: provided => ({\n    ...provided,\n    paddingLeft: 32,\n  }),\n};\n\ntype Props = {\n  organization: Organization;\n  teams: Team[];\n  onChange: (value: any) => any;\n  /**\n   * Function to control whether a team should be shown in the dropdown\n   */\n  teamFilter?: (team: Team) => boolean;\n  /**\n   * Can be used to restrict teams to a certain project and allow for new teams to be add to that project\n   */\n  project?: Project;\n  /**\n   * Controls whether the value in the dropdown is a team id or team slug\n   */\n  useId?: boolean;\n  includeUnassigned?: boolean;\n} & ControlProps;\n\ntype TeamActor = {\n  type: 'team';\n  id: string;\n  name: string;\n};\n\ntype TeamOption = {\n  value: string | null;\n  label: React.ReactElement;\n  searchKey: string;\n  actor: TeamActor | null;\n  disabled?: boolean;\n};\n\nfunction TeamSelector(props: Props) {\n  const {includeUnassigned, styles, ...extraProps} = props;\n  const {teams, teamFilter, organization, project, multiple, value, useId, onChange} =\n    props;\n\n  const api = useApi();\n  const [options, setOptions] = useState<TeamOption[]>([]);\n\n  // TODO(ts) This type could be improved when react-select types are better.\n  const selectRef = useRef<any>(null);\n\n  const createTeamOption = (team: Team): TeamOption => ({\n    value: useId ? team.id : team.slug,\n    label: <IdBadge team={team} />,\n    searchKey: `#${team.slug}`,\n    actor: {\n      type: 'team',\n      id: team.id,\n      name: team.slug,\n    },\n  });\n\n  /**\n   * Closes the select menu by blurring input if possible since that seems to\n   * be the only way to close it.\n   */\n  function closeSelectMenu() {\n    if (!selectRef.current) {\n      return;\n    }\n\n    const select = selectRef.current.select;\n    const input: HTMLInputElement = select.inputRef;\n\n    if (input) {\n      // I don't think there's another way to close `react-select`\n      input.blur();\n    }\n  }\n\n  async function handleAddTeamToProject(team: Team) {\n    if (!project) {\n      closeSelectMenu();\n      return;\n    }\n\n    // Copy old value\n    const oldValue = multiple ? [...(value ?? [])] : {value};\n    // Optimistic update\n    onChange?.(createTeamOption(team));\n\n    try {\n      await addTeamToProject(api, organization.slug, project.slug, team);\n\n      // Remove add to project button without changing order\n      const newOptions = options.map(option => {\n        if (option.actor?.id === team.id) {\n          option.disabled = false;\n          option.label = <IdBadge team={team} />;\n        }\n\n        return option;\n      });\n\n      setOptions(newOptions);\n    } catch (err) {\n      // Unable to add team to project, revert select menu value\n      onChange?.(oldValue);\n    }\n\n    closeSelectMenu();\n  }\n\n  function createTeamOutsideProjectOption(team: Team): TeamOption {\n    const canAddTeam = organization.access.includes('project:write');\n\n    return {\n      ...createTeamOption(team),\n      disabled: true,\n      label: (\n        <TeamOutsideProject>\n          <DisabledLabel>\n            <Tooltip\n              position=\"left\"\n              title={t('%s is not a member of project', `#${team.slug}`)}\n            >\n              <IdBadge team={team} />\n            </Tooltip>\n          </DisabledLabel>\n          <Tooltip\n            title={\n              canAddTeam\n                ? t('Add %s to project', `#${team.slug}`)\n                : t('You do not have permission to add team to project.')\n            }\n          >\n            <AddToProjectButton\n              type=\"button\"\n              size=\"zero\"\n              borderless\n              disabled={!canAddTeam}\n              onClick={() => handleAddTeamToProject(team)}\n              icon={<IconAdd isCircled />}\n            />\n          </Tooltip>\n        </TeamOutsideProject>\n      ),\n    };\n  }\n\n  function getInitialOptions() {\n    const filteredTeams = teamFilter ? teams.filter(teamFilter) : teams;\n\n    if (project) {\n      const teamsInProjectIdSet = new Set(project.teams.map(team => team.id));\n      const teamsInProject = filteredTeams.filter(team =>\n        teamsInProjectIdSet.has(team.id)\n      );\n      const teamsNotInProject = filteredTeams.filter(\n        team => !teamsInProjectIdSet.has(team.id)\n      );\n\n      return [\n        ...teamsInProject.map(createTeamOption),\n        ...teamsNotInProject.map(createTeamOutsideProjectOption),\n        ...(includeUnassigned ? [unassignedOption] : []),\n      ];\n    }\n\n    return [\n      ...filteredTeams.map(createTeamOption),\n      ...(includeUnassigned ? [unassignedOption] : []),\n    ];\n  }\n\n  useEffect(\n    () => void setOptions(getInitialOptions()),\n    [teams, teamFilter, project, includeUnassigned]\n  );\n\n  return (\n    <SelectControl\n      ref={selectRef}\n      options={options}\n      isOptionDisabled={option => !!option.disabled}\n      styles={{\n        ...(styles ?? {}),\n        ...(includeUnassigned ? unassignedSelectStyles : {}),\n        ...placeholderSelectStyles,\n      }}\n      {...extraProps}\n    />\n  );\n}\n\nconst TeamOutsideProject = styled('div')`\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-end;\n`;\n\nconst DisabledLabel = styled('div')`\n  display: flex;\n  opacity: 0.5;\n  overflow: hidden; /* Needed so that \"Add to team\" button can fit */\n`;\n\nconst AddToProjectButton = styled(Button)`\n  flex-shrink: 0;\n`;\n\nexport {TeamSelector};\n\n// TODO(davidenwang): this is broken due to incorrect types on react-select\nexport default withTeams(withOrganization(TeamSelector)) as unknown as (\n  p: Omit<Props, 'teams' | 'organization'>\n) => JSX.Element;\n"],"names":["UnassignedWrapper","StyledIconUser","IconUser","space","p","theme","gray400","unassignedOption","value","label","size","t","searchKey","actor","disabled","unassignedSelectStyles","option","provided","state","svg","color","isSelected","white","placeholderSelectStyles","input","display","gridTemplateColumns","alignItems","gridGap","backgroundColor","backgroundSecondary","height","width","borderRadius","content","placeholder","paddingLeft","TeamSelector","props","includeUnassigned","styles","extraProps","teams","teamFilter","organization","project","multiple","useId","onChange","api","useApi","options","setOptions","useState","selectRef","useRef","createTeamOption","team","id","slug","type","name","closeSelectMenu","current","select","inputRef","blur","createTeamOutsideProjectOption","canAddTeam","access","includes","TeamOutsideProject","DisabledLabel","position","title","AddToProjectButton","borderless","onClick","async","oldValue","addTeamToProject","newOptions","map","err","handleAddTeamToProject","icon","isCircled","useEffect","filteredTeams","filter","teamsInProjectIdSet","Set","teamsInProject","has","teamsNotInProject","getInitialOptions","ref","isOptionDisabled","Button","withTeams","withOrganization"],"sourceRoot":""}